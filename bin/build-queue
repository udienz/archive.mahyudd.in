#!/bin/bash

set -x

#apt-get -q --download-only -t ${d} source ${p}=${v}
BASE=/srv/buildd
suite=precise
repobase=$BASE/repo/
listpkg=$(mktemp)
incoming=$BASE/incoming/$suite
ARCH="amd64 i386"
LOCK=$BASE/lockbuild

prosess_incoming ()
{
	sudo reprepro -V -b $BASE/repo/ processincoming $1
	sudo chown udienz.udienz $BASE/www/ -R
	echo `date` > $BASE/www/ubuntu/project/trace/`hostname -f`
}
repo_buildneed ()
{
	reprepro -V -b $repobase build-needing $suite $1 
}

build_pkg ()
{
cat $listpkg  | sort -u |  while read paket versi alamat
        do
        cd $incoming/
                sbuild -n --arch=$1 -d $2-$1 $3 $BASE/www/ubuntu/$alamat > $BASE/incoming/log/"$paket"_"$versi"-"$2"-"$1".txt
        done
}


for arch in $ARCH
	do
	if [ $arch == amd64 ]; then
			prosess_incoming $suite
			repo_buildneed $arch > $listpkg
			repo_buildneed all >> $listpkg
			ARCH_SBUILD_OPTS="-A"
			# build_pkg $sbuild_opts --arch
			build_pkg $arch $suite "$ARCH_SBUILD_OPTS"
			rm -f $listpkg
		else
			prosess_incoming $suite
			repo_buildneed $arch > $listpkg
			ARCH_SBUILD_OPTS="--no-arch-all"
			build_pkg $arch $suite "$ARCH_SBUILD_OPTS"
			rm -f $listpkg
		fi
	done

prosess_incoming $suite
